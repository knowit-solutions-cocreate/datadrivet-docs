<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Datadrivet Infrastructure - Getting Started</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
            color: #333;
        }
        
        h1, h2, h3 {
            color: #2c3e50;
        }
        
        h1 {
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        
        h2 {
            margin-top: 30px;
            border-bottom: 1px solid #ecf0f1;
            padding-bottom: 5px;
        }
        
        .shell-tabs {
            display: flex;
            border-bottom: 1px solid #ccc;
            margin-bottom: 20px;
        }

        .shell-tab {
            background-color: #f1f1f1;
            border: none;
            outline: none;
            cursor: pointer;
            padding: 14px 16px;
            transition: 0.3s;
            font-size: 16px;
            border-top-left-radius: 5px;
            border-top-right-radius: 5px;
            margin-right: 2px;
        }

        .shell-tab:hover {
            background-color: #ddd;
        }

        .shell-tab.active {
            background-color: #ccc;
        }

        .shell-content {
            display: none;
            padding: 20px;
            border: 1px solid #ccc;
            border-top: none;
            border-radius: 0 0 5px 5px;
        }

        .shell-content.active {
            display: block;
        }

        .os-tabs {
            display: flex;
            border-bottom: 1px solid #ccc;
            margin-bottom: 20px;
            margin-top: 30px;
        }

        .os-tab {
            background-color: #e1f5fe;
            border: none;
            outline: none;
            cursor: pointer;
            padding: 14px 16px;
            transition: 0.3s;
            font-size: 16px;
            border-top-left-radius: 5px;
            border-top-right-radius: 5px;
            margin-right: 2px;
        }

        .os-tab:hover {
            background-color: #b3e5fc;
        }

        .os-tab.active {
            background-color: #81d4fa;
        }

        .os-content {
            display: none;
            padding: 20px;
            border: 1px solid #ccc;
            border-top: none;
            border-radius: 0 0 5px 5px;
        }

        .os-content.active {
            display: block;
        }

        pre {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            border-left: 4px solid #3498db;
        }

        code {
            background-color: #f8f9fa;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        }

        pre code {
            background-color: transparent;
            padding: 0;
        }

        .warning {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 5px;
            padding: 15px;
            margin: 15px 0;
        }

        .warning::before {
            content: "‚ö†Ô∏è ";
            font-weight: bold;
        }

        ul, ol {
            padding-left: 20px;
        }

        li {
            margin-bottom: 5px;
        }

        a {
            color: #3498db;
            text-decoration: none;
        }

        a:hover {
            text-decoration: underline;
        }

        .success-indicator {
            font-weight: bold;
            color: #27ae60;
        }
    </style>
</head>
<body>
    <h1>Getting Started with Datadrivet Infrastructure</h1>

    <h2>Prerequisites</h2>
    <ul>
        <li>GitHub account with access to <a href="https://github.com/orgs/knowit-solutions-cocreate/">knowit-solutions-cocreate</a> organization</li>
        <li>Access to the Datadrivet team</li>
        <li>Terminal access and curl installed</li>
    </ul>

    <h2>Overview</h2>
    <p>To minimize manual scripts, setups and "it works on my machine" problems, all repositories use a setup of Nix+Devenv+Direnv. This trinity of tools does a few things:</p>
    <ul>
        <li>Nix is a package manager. You won't have to touch it if you don't want to.</li>
        <li>Devenv is a wrapper on a subset of functionality of nix. It provides isolated development environments and simplifies working with nix.</li>
        <li>Direnv is a convenience package which hooks into your terminal to automatically source <code>.envrc</code> and <code>.env</code> files.</li>
    </ul>
    <p>Together, they create a robust foundation that facilitates collaboration and minimizes manual setups/configurations. This documentation will instruct you to setup nix+devenv+direnv, then configure access to secrets stored in these repositories.</p>

    <h2>1. Setting up the Trinity</h2>
    <p>Below are setups for Linux, macOS and Windows.</p>

    <h3>Identify Your Shell</h3>
    <p>To determine your current shell:</p>
    <pre><code>ps</code></pre>

    <div class="os-tabs">
        <button class="os-tab active" onclick="openOSTab(event, 'Linux')">Linux</button>
        <button class="os-tab" onclick="openOSTab(event, 'macOS')">macOS</button>
        <button class="os-tab" onclick="openOSTab(event, 'Windows')">Windows</button>
    </div>

    <div id="Linux" class="os-content active">
        <h3>1.1 Installing dependencies (Linux)</h3>
        
        <p>Install nix:</p>
        <pre><code>sh &lt;(curl -L https://nixos.org/nix/install) --daemon</code></pre>

        <p>Install devenv:</p>
        <pre><code>nix-env --install --attr devenv -f https://github.com/NixOS/nixpkgs/tarball/nixpkgs-unstable/</code></pre>

        <p>Install direnv:</p>
        <pre><code>nix-env --install --attr direnv -f https://github.com/NixOS/nixpkgs/tarball/nixpkgs-unstable</code></pre>

        <p>Add these lines to <code>/etc/nix/nix.conf</code>:</p>
        <pre><code>sudo tee -a /etc/nix/nix.conf &lt;&lt;EOF
extra-substituters = https://devenv.cachix.org
extra-trusted-public-keys = devenv.cachix.org-1:w1cLUi8dv3hnoSPGAuibQv+f9TZLr6cv/Hm9XgU50cw=
EOF</code></pre>

        <p>Then depending on the shell you are using:</p>

        <div class="shell-tabs">
            <button class="shell-tab active" onclick="openShellTab(event, 'bash-linux')">Bash</button>
            <button class="shell-tab" onclick="openShellTab(event, 'zsh-linux')">Zsh</button>
            <button class="shell-tab" onclick="openShellTab(event, 'fish-linux')">Fish</button>
        </div>

        <div id="bash-linux" class="shell-content active">
            <pre><code>echo 'eval "$(direnv hook bash)"' >> ~/.bashrc</code></pre>
        </div>

        <div id="zsh-linux" class="shell-content">
            <pre><code>echo 'eval "$(direnv hook zsh)"' >> ~/.zshrc</code></pre>
        </div>

        <div id="fish-linux" class="shell-content">
            <pre><code>echo 'eval "$(direnv hook fish)"' >> ~/.fishrc</code></pre>
        </div>

        <p>This sets up direnv to automatically activate the development environment when you enter that folder.</p>
        <p class="success-indicator">Success indicator: Commands complete without errors.</p>
    </div>

    <div id="macOS" class="os-content">
        <h3>1.2 Installing dependencies (macOS)</h3>
        
        <div class="warning">
            <strong>Important Note for Microsoft Defender for Mac Users:</strong> Microsoft Defender for Mac, which is bundled with new Knowit laptops, has severe performance issues with Nix and development environments due to real-time scanning of the many files involved. This makes the development environment crippingly slow.
            <br><br>
            <strong>Recommended solutions:</strong>
            <ol>
                <li><strong>Whitelist the Nix store:</strong> Add <code>/nix/store</code> and your project directory to Microsoft Defender's exclusions</li>
                <li><strong>Use a Remote machine:</strong> Consider using a remote machine in Kubernetes instead</li>
                <li><strong>Disable real-time protection:</strong> Temporarily disable real-time protection during development if possible</li>
            </ol>
            <strong>To add exclusions in Microsoft Defender for Mac:</strong>
            <ol>
                <li>Open Microsoft Defender for Mac</li>
                <li>Go to Preferences ‚Üí Threat Protection</li>
                <li>Under "Exclusions", add <code>/nix/store</code> and your project directory</li>
            </ol>
        </div>

        <p>Install nix:</p>
        <pre><code>curl -L https://github.com/NixOS/experimental-nix-installer/releases/download/0.27.0/nix-installer.sh | sh -s -- install</code></pre>

        <p>Install devenv:</p>
        <pre><code>nix-env --install --attr devenv -f https://github.com/NixOS/nixpkgs/tarball/nixpkgs-unstable/</code></pre>

        <p>Install direnv:</p>
        <pre><code>nix-env --install --attr direnv -f https://github.com/NixOS/nixpkgs/tarball/nixpkgs-unstable</code></pre>

        <p>Then depending on the shell you are using:</p>

        <div class="shell-tabs">
            <button class="shell-tab active" onclick="openShellTab(event, 'zsh-macos')">Zsh</button>
            <button class="shell-tab" onclick="openShellTab(event, 'bash-macos')">Bash</button>
            <button class="shell-tab" onclick="openShellTab(event, 'fish-macos')">Fish</button>
        </div>

        <div id="zsh-macos" class="shell-content active">
            <pre><code>echo 'eval "$(direnv hook zsh)"' >> ~/.zshrc</code></pre>
        </div>

        <div id="bash-macos" class="shell-content">
            <pre><code>echo 'eval "$(direnv hook bash)"' >> ~/.bashrc</code></pre>
        </div>

        <div id="fish-macos" class="shell-content">
            <pre><code>echo 'eval "$(direnv hook fish)"' >> ~/.fishrc</code></pre>
        </div>

        <p>Allow devenv's caching system:</p>
        <pre><code>sudo tee -a /etc/nix/nix.conf &lt;&lt;EOF
extra-substituters = https://devenv.cachix.org
extra-trusted-public-keys = devenv.cachix.org-1:w1cLUi8dv3hnoSPGAuibQv+f9TZLr6cv/Hm9XgU50cw=
EOF</code></pre>

        <p class="success-indicator">Success indicator: Commands complete without errors.</p>
    </div>

    <div id="Windows" class="os-content">
        <h3>1.3 Installing dependencies (Windows)</h3>
        
        <p>Use <a href="https://github.com/knowit-solutions-cocreate/nixos-wsl">NixOS-WSL</a>. This WSL distribution contains the necessary dependencies to work with the holy trinity nix+devenv+direnv. Navigate to it for further instructions. You can also choose to run your own WSL distribution and proceed from the previous section Installing dependencies (Linux).</p>

        <p>If you're using your own WSL distribution, you'll need to set up direnv hooks depending on the shell you are using:</p>

        <div class="shell-tabs">
            <button class="shell-tab active" onclick="openShellTab(event, 'bash-windows')">Bash</button>
            <button class="shell-tab" onclick="openShellTab(event, 'zsh-windows')">Zsh</button>
            <button class="shell-tab" onclick="openShellTab(event, 'fish-windows')">Fish</button>
        </div>

        <div id="bash-windows" class="shell-content active">
            <pre><code>echo 'eval "$(direnv hook bash)"' >> ~/.bashrc</code></pre>
        </div>

        <div id="zsh-windows" class="shell-content">
            <pre><code>echo 'eval "$(direnv hook zsh)"' >> ~/.zshrc</code></pre>
        </div>

        <div id="fish-windows" class="shell-content">
            <pre><code>echo 'eval "$(direnv hook fish)"' >> ~/.fishrc</code></pre>
        </div>

        <p class="success-indicator">Success indicator: WSL environment is running and accessible.</p>
    </div>

    <h2>2. Verification</h2>
    <p>Close your current terminal and open a new one. Then, clone the repo <a href="https://github.com/knowit-solutions-cocreate/datadrivet-infra-opendatastack/">datadrivet-infra-opendatastack</a> and cd into it:</p>

    <pre><code>direnv allow</code></pre>

    <p>You should see output similar to this:</p>
    <pre><code>datadrivet-infra-opendatastack on  feat/finalize-huge-refactor [!] is üì¶ v3.45.5 via üêç 
‚ùØ direnv allow  
direnv: loading ~/repos/knowit/datadrivet-infra-opendatastack/.envrc                                                                                                       
direnv: using devenv
‚Ä¢ Using Cachix caches: devenv
‚úì Building shell in 34.4ms
Running tasks     devenv:enterShell

Succeeded         devenv:python:uv                         31ms      
Succeeded         devenv:enterShell                        2ms       
*** CUT FOR BREVITY ***
  age1dj4tzl06h5lyftgvpkdf62483zsuj88swj5rny0wlrk02v54j9dscj4ekh: FAILED
    - | failed to load age identities: failed to open file: open
      | /home/user/.config/sops/age/keys.txt: no such file or
      | directory

Recovery failed because no master key was able to decrypt the file. In
order for SOPS to recover the file, at least one key has to be successful,
but none were.
direnv: using git_branch</code></pre>

    <p class="success-indicator">Success indicator: Environment loads and shows the SOPS error (expected - you don't have access to secrets yet). At this point you should be able to run devenv shell commands like <code>menu</code>. Verify that you can before proceeding to the next step.</p>

    <p>If installation fails, contact Alexander Reinthal or Jimmy Flatting.</p>

    <h2>3. Set Up Secrets Management</h2>
    <p>To decrypt secrets stored in git, you need a key pair and for someone to grant your key access to the secrets.</p>

    <h3>3.1 Generate an Age Key</h3>
    <p>Run this command:</p>
    <pre><code>setup-age-key</code></pre>

    <p>Output will look like this:</p>
    <pre><code>kog@test-ubuntu:~/datadrivet-infra-opendatastack$ setup-age-key
Setting up age key for sops...
Generating new age key...
Public key: age1vhctyw5e38fr8s6dmaygltsl0rtd6zd34tp88za4purrrcn7vqdq3hf0lw
Age key generated successfully!
Please save your public key and add it to .sops.yaml:
# public key: age1vhctyw5e38fr8s6dmaygltsl0rtd6zd34tp88za4purrrcn7vqdq3hf0lw</code></pre>

    <p><strong>Important:</strong></p>
    <ul>
        <li>Save the public key displayed in the terminal</li>
        <li>The private key is stored in <code>~/.config/sops/age/keys.txt</code> and should be kept secret</li>
        <li>You'll need to enter the public key in <code>.sops.yaml</code> located in the repository root</li>
    </ul>

    <p class="success-indicator">Success indicator: Public key is generated and displayed.</p>

    <h3>3.2 Add Your Key to the Project</h3>
    <ol>
        <li>Add your public key to <code>.sops.yaml</code>:
            <pre><code>keys:
  - &your_github_username age1your_public_key_here
creation_rules:
  - path_regex: secrets/[^/]+\.(yaml|json|env|ini)$
    key_groups:
      - age:
          - *your_github_username</code></pre>
        </li>
        <li>Create a Pull Request with your changes:
            <pre><code>git checkout -b add-user123-to-secrets
git add .sops.yaml
git commit -m "chore: add user123 to sops secrets"
git push origin HEAD</code></pre>
        </li>
        <li>Any team member who has already been granted access will:
            <ul>
                <li>Review your PR</li>
                <li>Run <code>updatekeys</code> command to add your key to the encrypted secrets on your branch and push the changes</li>
                <li>Approve and merge your PR</li>
            </ul>
        </li>
    </ol>

    <p class="success-indicator">Success indicator: PR is created and merged successfully.</p>

    <h3>3.3 Start Development</h3>
    <p>Once your PR is merged:</p>
    <pre><code>direnv allow</code></pre>

    <p>Output should show successful loading with environment variables like <code>AIRTABLE_ADS_ENDPOINT</code> being exported and accessible.</p>

    <p class="success-indicator">Success indicator: Environment variables are exported and accessible.</p>

    <h2>4. Browse Repository Options</h2>
    <pre><code>menu</code></pre>
    <p>Consult the repository specific documentation for next steps.</p>

    <script>
        function openShellTab(evt, shellName) {
            var i, shellContent, shellTabs;
            shellContent = document.getElementsByClassName("shell-content");
            for (i = 0; i < shellContent.length; i++) {
                shellContent[i].classList.remove("active");
            }
            shellTabs = document.getElementsByClassName("shell-tab");
            for (i = 0; i < shellTabs.length; i++) {
                shellTabs[i].classList.remove("active");
            }
            document.getElementById(shellName).classList.add("active");
            evt.currentTarget.classList.add("active");
        }

        function openOSTab(evt, osName) {
            var i, osContent, osTabs;
            osContent = document.getElementsByClassName("os-content");
            for (i = 0; i < osContent.length; i++) {
                osContent[i].classList.remove("active");
            }
            osTabs = document.getElementsByClassName("os-tab");
            for (i = 0; i < osTabs.length; i++) {
                osTabs[i].classList.remove("active");
            }
            document.getElementById(osName).classList.add("active");
            evt.currentTarget.classList.add("active");
        }

        // Set default tabs
        document.addEventListener('DOMContentLoaded', function() {
            // Set default shell tab to bash
            document.querySelector('.shell-tab').click();
            // Set default OS tab to Linux
            document.querySelector('.os-tab').click();
        });
    </script>
</body>
</html>
